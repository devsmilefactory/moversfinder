import React, { useState, useEffect } from 'react';\nimport { supabase } from '../../../lib/supabase';\nimport useAuthStore from '../../../stores/authStore';\nimport { ProfileErrorBoundary } from '../../shared/ProfileErrorBoundary';\nimport { LoadingSpinner } from '../../shared/loading';\nimport Button from '../../ui/Button';\nimport Icon from '../../ui/AppIcon';\n\n/**\n * ProfileFormContainer Component\n * \n * Base container component for all profile forms providing:\n * - Common state management\n * - Progress saving functionality\n * - Error handling\n * - Step navigation\n * - Form validation infrastructure\n */\nconst ProfileFormContainer = ({\n  profileType = 'driver', // 'driver' | 'corporate' | 'individual'\n  totalSteps = 5,\n  initialData = {},\n  onComplete,\n  onStepChange,\n  children,\n  className = ''\n}) => {\n  const user = useAuthStore((state) => state.user);\n  const [currentStep, setCurrentStep] = useState(1);\n  const [formData, setFormData] = useState(initialData);\n  const [errors, setErrors] = useState({});\n  const [saving, setSaving] = useState(false);\n  const [savingProgress, setSavingProgress] = useState(false);\n  const [showSaveProgressModal, setShowSaveProgressModal] = useState(false);\n  const [savedCompletionPercentage, setSavedCompletionPercentage] = useState(0);\n  const [isLoading, setIsLoading] = useState(true);\n\n  // Load existing profile data on mount\n  useEffect(() => {\n    loadExistingProfile();\n  }, [user?.id, profileType]);\n\n  // Notify parent of step changes\n  useEffect(() => {\n    onStepChange?.(currentStep);\n  }, [currentStep, onStepChange]);\n\n  const getTableName = () => {\n    switch (profileType) {\n      case 'driver':\n        return 'driver_profiles';\n      case 'corporate':\n        return 'corporate_profiles';\n      case 'individual':\n        return 'individual_profiles';\n      default:\n        return 'profiles';\n    }\n  };\n\n  const loadExistingProfile = async () => {\n    if (!user?.id) {\n      setIsLoading(false);\n      return;\n    }\n\n    try {\n      const { data: existingProfile, error } = await supabase\n        .from(getTableName())\n        .select('*')\n        .eq('user_id', user.id)\n        .single();\n\n      if (error && error.code !== 'PGRST116') {\n        console.error('Error loading profile:', error);\n      }\n\n      if (existingProfile) {\n        setFormData(prev => ({ ...prev, ...existingProfile }));\n        \n        // Determine current step based on completion\n        const completedStep = calculateCompletedStep(existingProfile);\n        setCurrentStep(Math.min(completedStep + 1, totalSteps));\n      }\n    } catch (err) {\n      console.error('Error loading existing profile:', err);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const calculateCompletedStep = (profile) => {\n    // This should be overridden by specific profile forms\n    // Default implementation based on common fields\n    if (profile.bank_name && profile.account_number) return 5;\n    if (profile.vehicle_make || profile.company_name) return 4;\n    if (profile.license_number || profile.business_registration) return 3;\n    if (profile.full_name && profile.date_of_birth) return 2;\n    if (profile.license_plate || profile.company_address) return 1;\n    return 0;\n  };\n\n  const handleInputChange = (name, value) => {\n    setFormData(prev => ({ ...prev, [name]: value }));\n    \n    // Clear error for this field\n    if (errors[name]) {\n      setErrors(prev => ({ ...prev, [name]: '' }));\n    }\n  };\n\n  const handleFileChange = (fieldName, file) => {\n    setFormData(prev => ({ ...prev, [fieldName]: file }));\n    \n    // Clear error for this field\n    if (errors[fieldName]) {\n      setErrors(prev => ({ ...prev, [fieldName]: '' }));\n    }\n  };\n\n  const setFieldError = (fieldName, errorMessage) => {\n    setErrors(prev => ({ ...prev, [fieldName]: errorMessage }));\n  };\n\n  const clearErrors = () => {\n    setErrors({});\n  };\n\n  const validateStep = (step, validationRules) => {\n    if (!validationRules || !validationRules[step]) {\n      return true;\n    }\n\n    const newErrors = {};\n    const rules = validationRules[step];\n\n    rules.forEach(rule => {\n      const { field, required, validator, message } = rule;\n      const value = formData[field];\n\n      if (required && (!value || (typeof value === 'string' && !value.trim()))) {\n        newErrors[field] = message || `${field} is required`;\n      } else if (value && validator && !validator(value)) {\n        newErrors[field] = message || `Invalid ${field}`;\n      }\n    });\n\n    setErrors(newErrors);\n    return Object.keys(newErrors).length === 0;\n  };\n\n  const handleNext = (validationRules) => {\n    if (validateStep(currentStep, validationRules)) {\n      setCurrentStep(prev => Math.min(prev + 1, totalSteps));\n    }\n  };\n\n  const handleBack = () => {\n    setCurrentStep(prev => Math.max(prev - 1, 1));\n  };\n\n  const saveProgress = async (customData = {}) => {\n    setSavingProgress(true);\n    setErrors({});\n\n    try {\n      const completionPercentage = (currentStep / totalSteps) * 100;\n\n      // Check if profile exists\n      const { data: existingProfile } = await supabase\n        .from(getTableName())\n        .select('id')\n        .eq('user_id', user.id)\n        .single();\n\n      // Prepare profile data\n      const profileData = {\n        user_id: user.id,\n        submission_status: 'draft',\n        updated_at: new Date().toISOString(),\n        ...customData\n      };\n\n      // Filter out null/undefined values and files\n      Object.keys(profileData).forEach(key => {\n        const value = profileData[key];\n        if (value === null || value === undefined || \n            (typeof value === 'object' && value instanceof File)) {\n          delete profileData[key];\n        }\n      });\n\n      // Save or update profile\n      if (existingProfile) {\n        const { error: updateError } = await supabase\n          .from(getTableName())\n          .update(profileData)\n          .eq('user_id', user.id);\n\n        if (updateError) throw updateError;\n      } else {\n        const { error: insertError } = await supabase\n          .from(getTableName())\n          .insert(profileData);\n\n        if (insertError) throw insertError;\n      }\n\n      setSavedCompletionPercentage(Math.round(completionPercentage));\n      setShowSaveProgressModal(true);\n    } catch (err) {\n      console.error('Error saving progress:', err);\n      setErrors({ general: err.message || 'Failed to save progress. Please try again.' });\n    } finally {\n      setSavingProgress(false);\n    }\n  };\n\n  const handleSubmit = async (finalData = {}, uploadFiles = []) => {\n    setSaving(true);\n    setErrors({});\n\n    try {\n      // Handle file uploads first\n      const uploadedFiles = {};\n      for (const fileConfig of uploadFiles) {\n        const { fieldName, file, bucket = 'documents' } = fileConfig;\n        if (file && file instanceof File) {\n          const fileExt = file.name.split('.').pop();\n          const fileName = `${user.id}/${fieldName}_${Date.now()}.${fileExt}`;\n          \n          const { data: uploadData, error: uploadError } = await supabase.storage\n            .from(bucket)\n            .upload(fileName, file);\n\n          if (uploadError) throw uploadError;\n          \n          const { data: { publicUrl } } = supabase.storage\n            .from(bucket)\n            .getPublicUrl(fileName);\n          \n          uploadedFiles[fieldName] = publicUrl;\n        }\n      }\n\n      // Prepare final profile data\n      const profileData = {\n        user_id: user.id,\n        submission_status: 'submitted',\n        submitted_at: new Date().toISOString(),\n        ...formData,\n        ...uploadedFiles,\n        ...finalData\n      };\n\n      // Filter out file objects\n      Object.keys(profileData).forEach(key => {\n        if (profileData[key] instanceof File) {\n          delete profileData[key];\n        }\n      });\n\n      // Check if profile exists\n      const { data: existingProfile } = await supabase\n        .from(getTableName())\n        .select('id')\n        .eq('user_id', user.id)\n        .single();\n\n      // Save or update profile\n      if (existingProfile) {\n        const { error: updateError } = await supabase\n          .from(getTableName())\n          .update(profileData)\n          .eq('user_id', user.id);\n\n        if (updateError) throw updateError;\n      } else {\n        const { error: insertError } = await supabase\n          .from(getTableName())\n          .insert(profileData);\n\n        if (insertError) throw insertError;\n      }\n\n      // Call completion callback\n      onComplete?.();\n    } catch (err) {\n      console.error('Error submitting profile:', err);\n      setErrors({ general: err.message || 'Failed to submit profile. Please try again.' });\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center py-12\">\n        <LoadingSpinner size=\"lg\" />\n      </div>\n    );\n  }\n\n  const containerProps = {\n    currentStep,\n    totalSteps,\n    formData,\n    errors,\n    saving,\n    savingProgress,\n    handleInputChange,\n    handleFileChange,\n    setFieldError,\n    clearErrors,\n    handleNext,\n    handleBack,\n    saveProgress,\n    handleSubmit,\n    validateStep\n  };\n\n  return (\n    <ProfileErrorBoundary>\n      <div className={`max-w-2xl mx-auto ${className}`}>\n        {/* Render children with container props */}\n        {typeof children === 'function' ? children(containerProps) : children}\n\n        {/* Save Progress Modal */}\n        {showSaveProgressModal && (\n          <div className=\"fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm\">\n            <div className=\"relative w-full max-w-md bg-white rounded-2xl shadow-2xl p-8 m-4\">\n              <div className=\"text-center space-y-4\">\n                {/* Success Icon */}\n                <div className=\"mx-auto w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center\">\n                  <Icon name=\"Save\" className=\"w-10 h-10 text-blue-600\" />\n                </div>\n\n                {/* Title */}\n                <h3 className=\"text-2xl font-bold text-gray-900\">\n                  Progress Saved!\n                </h3>\n\n                {/* Message */}\n                <div className=\"space-y-2\">\n                  <p className=\"text-gray-600\">\n                    Your profile is now <span className=\"font-semibold text-blue-600\">{savedCompletionPercentage}% complete</span>.\n                  </p>\n                  <p className=\"text-sm text-gray-500\">\n                    You can continue completing your profile anytime. Your progress has been saved.\n                  </p>\n                </div>\n\n                {/* Progress Bar */}\n                <div className=\"w-full bg-gray-200 rounded-full h-3 overflow-hidden\">\n                  <div\n                    className=\"bg-gradient-to-r from-blue-500 to-blue-600 h-full transition-all duration-500 rounded-full\"\n                    style={{ width: `${savedCompletionPercentage}%` }}\n                  />\n                </div>\n\n                {/* Close Button */}\n                <Button\n                  onClick={() => setShowSaveProgressModal(false)}\n                  className=\"w-full\"\n                >\n                  Continue\n                </Button>\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n    </ProfileErrorBoundary>\n  );\n};\n\nexport default ProfileFormContainer;"